#!/usr/bin/env python3
"""
Script to update app.py with improved UI features:
1. Sample FEN positions
2. Preserve FEN input after analysis
3. Reset button functionality
"""

import re

def update_app_py():
    # Read the current app.py
    with open('app.py', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Define sample FEN positions
    sample_fens = [
        ("Starting Position", "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"),
        ("Scholar's Mate Setup", "r1bqkb1r/pppp1ppp/2n2n2/4p3/2B1P3/3P1N2/PPP2PPP/RNBQK2R w KQkq - 4 4"),
        ("Queen's Gambit", "rnbqkbnr/ppp1pppp/8/3p4/2PP4/8/PP2PPPP/RNBQKBNR b KQkq c3 0 2"),
        ("Endgame Position", "6k1/5ppp/8/8/8/2K5/5PPP/8 w - - 0 1"),
        ("Tactical Position", "r3k2r/ppp2ppp/2n1bn2/2bpp3/2P5/2N1PN2/PPBP1PPP/R1BQKR2 w Qkq - 0 8")
    ]
    
    # 1. Update the main route to accept 'current_fen' parameter and pass it to template
    route_pattern = r"(@app\.route\('/'.*?\ndef analyze_chess_move\(\):.*?msg = request\.args\.get\('msg', ''\))"
    route_replacement = r"\1\n    current_fen = request.args.get('current_fen', '')"
    content = re.sub(route_pattern, route_replacement, content, flags=re.DOTALL)
    
    # 2. Update the template rendering to include current_fen and sample_fens
    template_pattern = r"(return render_template_string\('''.*?msg=msg, fen_result=fen_result\))"
    template_replacement = r"return render_template_string('''\n            <html>\n            <head>\n                <title>Analyze Next Best Chess Move!</title>\n                <style>\n                    body { \n                        font-family: Arial, sans-serif; \n                        max-width: 800px; \n                        margin: 0 auto; \n                        padding: 20px; \n                        background: linear-gradient(135deg, #f3e7ff 0%, #e6d3ff 100%);\n                        min-height: 100vh;\n                    }\n                    .header { text-align: center; margin-bottom: 30px; color: #4a2c7a; }\n                    .main-form { \n                        text-align: center; \n                        margin-bottom: 30px; \n                        padding: 20px; \n                        background: rgba(255, 255, 255, 0.8); \n                        border-radius: 12px; \n                        box-shadow: 0 4px 15px rgba(116, 77, 169, 0.15);\n                        border: 1px solid #d4b3ff;\n                    }\n                    .fen-input { \n                        padding: 10px; \n                        font-size: 16px; \n                        width: 400px; \n                        border: 2px solid #c299ff; \n                        border-radius: 6px; \n                        background: rgba(255, 255, 255, 0.9);\n                    }\n                    .fen-input:focus { border-color: #9966ff; outline: none; box-shadow: 0 0 5px rgba(153, 102, 255, 0.3); }\n                    .fen-input.analyzed { background-color: #f0f8ff; color: #666; }\n                    .submit-btn { \n                        padding: 12px 30px; \n                        font-size: 16px; \n                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%); \n                        color: white; \n                        border: none; \n                        border-radius: 6px; \n                        cursor: pointer; \n                        margin-top: 10px;\n                        margin-right: 10px;\n                        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);\n                    }\n                    .submit-btn:hover { \n                        background: linear-gradient(135deg, #218838 0%, #1ea085 100%); \n                        transform: translateY(-1px);\n                        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);\n                    }\n                    .reset-btn { \n                        padding: 12px 30px; \n                        font-size: 16px; \n                        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); \n                        color: white; \n                        border: none; \n                        border-radius: 6px; \n                        cursor: pointer; \n                        margin-top: 10px;\n                        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);\n                    }\n                    .reset-btn:hover { \n                        background: linear-gradient(135deg, #5a6268 0%, #495057 100%); \n                        transform: translateY(-1px);\n                        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);\n                    }\n                    .sample-fens {\n                        margin: 15px 0;\n                        text-align: left;\n                    }\n                    .sample-fen-btn {\n                        display: inline-block;\n                        margin: 3px;\n                        padding: 5px 10px;\n                        background: linear-gradient(135deg, #8b5fbf 0%, #7048a3 100%);\n                        color: white;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                        font-size: 12px;\n                        text-decoration: none;\n                    }\n                    .sample-fen-btn:hover {\n                        background: linear-gradient(135deg, #7048a3 0%, #5d3d87 100%);\n                        transform: translateY(-1px);\n                    }\n                    .engine-buttons { \n                        display: flex; \n                        gap: 10px; \n                        justify-content: center; \n                        flex-wrap: wrap;\n                        margin-top: 10px;\n                    }\n                    .engine-btn { \n                        padding: 8px 16px; \n                        background: linear-gradient(135deg, #8b5fbf 0%, #7048a3 100%); \n                        color: white; \n                        border: none; \n                        border-radius: 6px; \n                        cursor: pointer;\n                        box-shadow: 0 2px 6px rgba(139, 95, 191, 0.3);\n                    }\n                    .engine-btn:hover { \n                        background: linear-gradient(135deg, #7048a3 0%, #5d3d87 100%); \n                        transform: translateY(-1px);\n                        box-shadow: 0 3px 8px rgba(139, 95, 191, 0.4);\n                    }\n                    .about-section { \n                        background: rgba(255, 255, 255, 0.7); \n                        padding: 15px; \n                        border-radius: 12px; \n                        margin-top: 20px; \n                        border: 1px solid #d4b3ff;\n                        color: #4a2c7a;\n                    }\n                    .msg { \n                        padding: 8px; \n                        margin-bottom: 10px; \n                        background: rgba(255, 255, 255, 0.8); \n                        border: 1px solid #c299ff; \n                        border-radius: 6px; \n                        color: #4a2c7a;\n                    }\n                    h3 { color: #4a2c7a; margin-bottom: 15px; }\n                    .result-section {\n                        text-align: center;\n                        margin-bottom: 30px;\n                        padding: 20px;\n                        background: rgba(255, 255, 255, 0.8);\n                        border-radius: 12px;\n                        box-shadow: 0 4px 15px rgba(116, 77, 169, 0.15);\n                        border: 1px solid #d4b3ff;\n                    }\n                 .recommend-label { font-size: 1.2em; font-weight: bold; color: #4a2c7a; margin-bottom: 8px; }\n                 .recommend-value { font-size: 1.3em; color: #218838; margin-bottom: 18px; }\n                 .board-container {\n                     display: flex;\n                     justify-content: center;\n                     margin: 15px auto;\n                 }\n                 .chess-board {\n                     border: 3px solid #8B4513;\n                     border-radius: 8px;\n                     padding: 5px;\n                     background: #DEB887;\n                     box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n                 }\n                 .board-row {\n                     display: flex;\n                     margin: 0;\n                 }\n                 .chess-square {\n                     width: 35px;\n                     height: 35px;\n                     display: flex;\n                     align-items: center;\n                     justify-content: center;\n                     position: relative;\n                 }\n                 .chess-square.light {\n                     background-color: #F0D9B5;\n                 }\n                 .chess-square.dark {\n                     background-color: #B58863;\n                 }\n                 .chess-square.from-square {\n                     background-color: #FFE135 !important;\n                     box-shadow: inset 0 0 0 2px #FF6B35;\n                 }\n                 .chess-square.to-square {\n                     background-color: #90EE90 !important;\n                     box-shadow: inset 0 0 0 2px #228B22;\n                 }\n                 .chess-piece {\n                     font-size: 24px;\n                     font-weight: bold;\n                     text-shadow: 1px 1px 1px rgba(0,0,0,0.3);\n                 }\n                 .chess-piece.white {\n                     color: #FFFFFF;\n                     filter: drop-shadow(1px 1px 1px #000);\n                 }\n                 .chess-piece.black {\n                     color: #000000;\n                     filter: drop-shadow(1px 1px 1px #FFF);\n                 }\n                 .rank-label, .file-label {\n                     width: 35px;\n                     height: 35px;\n                     display: flex;\n                     align-items: center;\n                     justify-content: center;\n                     font-weight: bold;\n                     color: #8B4513;\n                     font-size: 12px;\n                 }\n                 .file-labels {\n                     margin-top: 2px;\n                 }\n                </style>\n                <script>\n                    function loadSampleFEN(fen) {\n                        document.getElementById('fen').value = fen;\n                    }\n                    function resetForm() {\n                        window.location.href = '/';\n                    }\n                </script>\n            </head>\n            <body>\n                <div class=\"header\">\n                    <img src=\"/assets/chess_icon.png\" alt=\"Chess Icon\" style=\"height:64px;vertical-align:middle;margin-right:12px;\">\n                    <span style=\"font-size:2em;font-weight:bold;vertical-align:middle;\">Analyze Next Best Chess Move!</span>\n                </div>\n                \n                {% if msg %}<div class=\"msg\">{{msg}}</div>{% endif %}\n                \n                <div class=\"main-form\">\n                    <form action=\"/submit\" method=\"post\">\n                        <div style=\"margin-bottom: 15px;\">\n                            <label for=\"fen\" style=\"display: block; margin-bottom: 8px; font-weight: bold; font-size: 18px;\">Enter FEN Position:</label>\n                            <input type=\"text\" name=\"fen\" id=\"fen\" class=\"fen-input{% if fen_result %} analyzed{% endif %}\" placeholder=\"Enter FEN notation here...\" value=\"{{current_fen}}\">\n                            <div style=\"font-size: 11px; color: #7a6b93; margin-top: 5px; font-style: italic;\">\n                                FEN (Forsyth-Edwards Notation) describes a chess position: piece placement, turn, castling rights, en passant, and move counts\n                            </div>\n                        </div>\n                        \n                        <div class=\"sample-fens\">\n                            <div style=\"font-weight: bold; margin-bottom: 8px; color: #4a2c7a;\">Sample Positions:</div>\n                            <button type=\"button\" class=\"sample-fen-btn\" onclick=\"loadSampleFEN('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1')\">Starting Position</button>\n                            <button type=\"button\" class=\"sample-fen-btn\" onclick=\"loadSampleFEN('r1bqkb1r/pppp1ppp/2n2n2/4p3/2B1P3/3P1N2/PPP2PPP/RNBQK2R w KQkq - 4 4')\">Scholar's Mate Setup</button>\n                            <button type=\"button\" class=\"sample-fen-btn\" onclick=\"loadSampleFEN('rnbqkbnr/ppp1pppp/8/3p4/2PP4/8/PP2PPPP/RNBQKBNR b KQkq c3 0 2')\">Queen's Gambit</button>\n                            <button type=\"button\" class=\"sample-fen-btn\" onclick=\"loadSampleFEN('6k1/5ppp/8/8/8/2K5/5PPP/8 w - - 0 1')\">Endgame Position</button>\n                            <button type=\"button\" class=\"sample-fen-btn\" onclick=\"loadSampleFEN('r3k2r/ppp2ppp/2n1bn2/2bpp3/2P5/2N1PN2/PPBP1PPP/R1BQKR2 w Qkq - 0 8')\">Tactical Position</button>\n                        </div>\n                        \n                        <button type=\"submit\" class=\"submit-btn\">Analyze Position</button>\n                        <button type=\"button\" class=\"reset-btn\" onclick=\"resetForm()\">Reset</button>\n                    </form>\n                </div>\n\n                {% if fen_result %}\n                <div class=\"recommendations-wrapper\">\n                    <h3 class=\"recommendations-header\">Move Recommendations</h3>\n                    \n                    <div class=\"recommendation-section\">\n                        <div class=\"recommend-label\">Stockfish Recommendation</div>\n                        <div class=\"recommend-value\">{{fen_result['stockfish']}}</div>\n                        {% if fen_result['stockfish_board'] %}\n                        <div class=\"board-container\">\n                            {{fen_result['stockfish_board']|safe}}\n                        </div>\n                        {% endif %}\n                    </div>\n                    \n                    <div class=\"recommendation-section\">\n                        <div class=\"recommend-label\">AI Recommendation (Built-in Chess Logic Engine)</div>\n                        <div class=\"recommend-value\">{{fen_result['ai']}}</div>\n                        <div style=\"font-size: 11px; color: #7a6b93; margin-top: 5px; font-style: italic;\">\n                            Generated using custom chess principles AI (evaluation-based move scoring)\n                        </div>\n                        {% if fen_result['ai_board'] %}\n                        <div class=\"board-container\">\n                            {{fen_result['ai_board']|safe}}\n                        </div>\n                        {% endif %}\n                    </div>\n                </div>\n                {% endif %}\n\n                <div class=\"about-section\">\n                    <h3>About</h3>\n                    <h4 style=\"color: #4a2c7a; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #8e44ad; padding-bottom: 10px;\">Component Management</h4>\n                    \n                    <!-- Stockfish Engine Section -->\n                    <div style=\"margin-bottom: 25px; padding: 15px; background-color: rgba(142, 68, 173, 0.05); border: 1px solid #d4b3ff; border-radius: 8px;\">\n                        <h4 style=\"color: #4a2c7a; margin-bottom: 15px; display: flex; align-items: center;\">\n                            <span style=\"font-size: 20px; margin-right: 10px;\">‚ôö</span>Stockfish Chess Engine\n                        </h4>\n                        {% if current %}\n                            <div style=\"margin-bottom: 10px;\"><strong>Path:</strong> {{current}}</div>\n                            <div style=\"margin-bottom: 10px;\"><strong>Current Version:</strong> {{version}}</div>\n                            {% if latest_tag %}<div style=\"margin-bottom: 10px;\"><strong>Latest Available:</strong> {{latest_tag}}</div>{% endif %}\n                            <div style=\"margin-bottom: 15px;\"><strong>Status:</strong> \n                                <span style=\"color:{% if stockfish_update_available %}orange{% else %}green{% endif %};font-weight:bold;\">\n                                    {% if stockfish_update_available %}Update Available ({{latest_tag}}){% else %}Up to Date{% endif %}\n                                </span>\n                            </div>\n                            <div class=\"engine-buttons\">\n                                <form action=\"/update_engine_now\" method=\"post\" style=\"display: inline;\">\n                                    <button type=\"submit\" class=\"engine-btn\" {% if not stockfish_update_available %}style=\"opacity: 0.5;\" disabled{% endif %}>Update Now</button>\n                                </form>\n                                <form action=\"/rollback_engine_now\" method=\"post\" style=\"display: inline;\">\n                                    <button type=\"submit\" class=\"engine-btn\">Rollback</button>\n                                </form>\n                            </div>\n                        {% else %}\n                            <div style=\"color:#b00; margin-bottom: 15px;\">Engine not installed</div>\n                            <div class=\"engine-buttons\">\n                                <form action=\"/update_engine_now\" method=\"post\" style=\"display: inline;\">\n                                    <button type=\"submit\" class=\"engine-btn\">Install Engine</button>\n                                </form>\n                            </div>\n                        {% endif %}\n                    </div>\n                    \n                    <!-- Python Dependencies Sections -->\n                    {% for dep in python_deps %}\n                    <div style=\"margin-bottom: 25px; padding: 15px; background-color: rgba(142, 68, 173, 0.05); border: 1px solid #d4b3ff; border-radius: 8px;\">\n                        <h4 style=\"color: #4a2c7a; margin-bottom: 15px; display: flex; align-items: center;\">\n                            <span style=\"font-size: 20px; margin-right: 10px;\">üêç</span>{{ dep.name }} Package\n                        </h4>\n                        <div style=\"margin-bottom: 10px;\"><strong>Current Version:</strong> {{ dep.current_version }}</div>\n                        <div style=\"margin-bottom: 10px;\"><strong>Latest Available:</strong> {{ dep.latest_version }}</div>\n                        <div style=\"margin-bottom: 15px;\"><strong>Status:</strong> \n                            <span style=\"color:{% if dep.update_available %}orange{% else %}green{% endif %};font-weight:bold;\">\n                                {% if dep.update_available %}Update Available ({{ dep.latest_version }}){% else %}Up to Date{% endif %}\n                            </span>\n                        </div>\n                        <div class=\"engine-buttons\">\n                            <form action=\"/update_package\" method=\"post\" style=\"display: inline;\">\n                                <input type=\"hidden\" name=\"package\" value=\"{{ dep.name }}\" />\n                                <input type=\"hidden\" name=\"version\" value=\"{{ dep.latest_version }}\" />\n                                <button type=\"submit\" class=\"engine-btn\" {% if not dep.update_available %}style=\"opacity: 0.5;\" disabled{% endif %}>Update Now</button>\n                            </form>\n                            <form action=\"/rollback_package\" method=\"post\" style=\"display: inline;\">\n                                <input type=\"hidden\" name=\"package\" value=\"{{ dep.name }}\" />\n                                <button type=\"submit\" class=\"engine-btn\">Rollback</button>\n                            </form>\n                        </div>\n                    </div>\n                    {% endfor %}\n                    \n                    <div style=\"text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #d4b3ff; font-size: 12px; color: #7a6b93;\">\n                        ¬© 2025 Drake Svc LLC. All rights reserved.<br>\n                        <a href=\"https://github.com/AprilLorDrake\" target=\"_blank\" style=\"color: #8b5fbf; text-decoration: none; margin-top: 5px; display: inline-block;\">\n                            GitHub: AprilLorDrake\n                        </a>\n                    </div>\n                </div>\n            </body>\n            </html>\n        ''', current=current, version=version, latest_tag=latest_tag, stockfish_update_available=stockfish_update_available, python_deps=python_deps, msg=msg, fen_result=fen_result, current_fen=current_fen)"
    
    # 3. Update the submit route to preserve FEN
    submit_pattern = r"(@app\.route\('/submit', methods=\['POST'\]\)\ndef submit\(\):.*?fen = request\.form\.get\('fen', ''\)\.strip\(\).*?# Redirect to main page with FEN parameter for analysis\s+if fen:\s+return redirect\(url_for\('analyze_chess_move', fen=fen\)\))"
    submit_replacement = r"@app.route('/submit', methods=['POST'])\ndef submit():\n    fen = request.form.get('fen', '').strip()\n    \n    # Redirect to main page with FEN parameter for analysis\n    if fen:\n        return redirect(url_for('analyze_chess_move', fen=fen, current_fen=fen))"
    content = re.sub(submit_pattern, submit_replacement, content, flags=re.DOTALL)
    
    # Write the updated content
    with open('app.py.new', 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("Updated app.py.new created successfully!")
    return True

if __name__ == "__main__":
    update_app_py()